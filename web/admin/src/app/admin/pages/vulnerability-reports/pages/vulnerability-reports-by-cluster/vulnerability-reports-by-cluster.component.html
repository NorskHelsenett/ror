<div *ngIf="vulnerabilityReports$ | async as vulnerabilityReports; else loadingOrError">
  <p-table
    #clusterTable
    [loading]="loading"
    [sortOrder]="-1"
    sortField="criticalCount"
    [value]="vulnerabilityReports"
    [columns]="columns"
    [tableStyle]="{ 'min-width': '50rem' }"
  >
    <ng-template pTemplate="header" let-columns>
      <tr>
        <th *ngFor="let column of columns" [pSortableColumn]="column?.field" class="p-0">
          {{ 'pages.admin.vulnerabilityreports.clusterSummary.' + column?.field | translate }}<p-sortIcon [field]="column?.field"></p-sortIcon>
        </th>
      </tr>
      <tr>
        <th *ngFor="let column of columns" class="p-0">
          <container-element [ngSwitch]="column?.type">
            <p-columnFilter *ngSwitchCase="'text'" type="text" [field]="column?.field" matchMode="contains" [showMenu]="false"></p-columnFilter>
            <p-columnFilter *ngSwitchCase="'env'" [field]="column?.field" matchMode="in" [showMenu]="false">
              <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                <p-multiSelect
                  [ngModel]="value"
                  appendTo="body"
                  [options]="environments"
                  placeholder="{{ 'common.any' | translate }}"
                  (onChange)="filter($event.value)"
                  optionLabel="name"
                  optionValue="value"
                  [maxSelectedLabels]="1"
                  [selectedItemsLabel]="'{0} items'"
                  [filter]="false"
                >
                </p-multiSelect>
              </ng-template>
            </p-columnFilter>
          </container-element>
        </th>
      </tr>
    </ng-template>
    <ng-template pTemplate="caption">
      <p-iconField iconPosition="left">
        <input
          pInputText
          #globalSearchInput
          type="text"
          class="block w-full p-2 ps-10 text-sm text-gray-900 border border-gray-300 rounded-lg bg-gray-50 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
          (input)="clusterTable.filterGlobal(globalSearchInput?.value, 'contains')"
          placeholder="{{ 'common.search' | translate }}"
        />
      </p-iconField>
    </ng-template>
    <ng-template pTemplate="body" let-report let-columns="columns">
      <tr>
        <ng-container *ngFor="let column of columns">
          <ng-container [ngSwitch]="column?.field">
            <td *ngSwitchCase="'clusterId'">
              <a
                [routerLink]="['./../../cluster/' + report?.clusterId]"
                [queryParams]="{ tab: 'vulnerabilityReports' }"
                class="ml-2 cursor-pointer hover:text-blue-800 hover:underline dark:hover:text-blue-400"
                >{{ report?.clusterId }}</a
              >
            </td>
            <td *ngSwitchCase="'project.name'">
              <a
                [routerLink]="['./../projects/' + report?.project?.id]"
                class="ml-2 cursor-pointer hover:text-blue-800 hover:underline dark:hover:text-blue-400"
                >{{ report?.project?.name }}</a
              >
            </td>

            <td *ngSwitchCase="'environment'">
              <app-cluster-environment [environmentTag]="report?.environment"></app-cluster-environment>
            </td>
            <td *ngSwitchDefault>{{ report[column?.field] }}</td>
          </ng-container>
        </ng-container>
      </tr>
    </ng-template>
    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="5">
          {{ 'common.emptyList' | translate }}
        </td>
      </tr>
    </ng-template>
  </p-table>
</div>

<ng-template #loadingOrError>
  <ng-container *ngIf="error; else workspaceLoading">
    <div class="mx-auto my-4 flex items-center rounded-md bg-red-200 px-6 py-4 text-lg">
      <span class="p-2 text-red-800"> {{ 'pages.dashboard.error' | translate }} </span>
      <button class="btn text-black" (click)="getVulnerabilityReports()">{{ 'common.tryAgain' | translate }}</button>
    </div>
  </ng-container>
  <ng-template #workspaceLoading>
    <app-spinner></app-spinner>
  </ng-template>
</ng-template>
