<div class="flex flex-col gap-5">
  <div class="flex flex-col gap-1">
    <div class="flex flex-row gap-1">
      <span class="p-input-icon-left">
        <input
          #cveinput
          type="text"
          class="form-control m-0 block w-full text-lg rounded border border-solid border-gray-300 bg-white bg-clip-padding px-3 py-1.5 text-base font-normal text-gray-600 transition ease-in-out focus:bg-white focus:text-gray-700 focus:outline-none dark:bg-gray-700 dark:text-white"
          aria-describedby="cveid-help"
          [(ngModel)]="id"
          (keyup.enter)="getVulnerabilityReports()"
        />
      </span>
      <button
        class="focus:ring-primary dark:focus:ring-offset-dark ml-2 rounded-md bg-green-700 px-4 py-2 text-lg text-white hover:bg-green-500 focus:outline-none focus:ring focus:ring-offset-1 focus:ring-offset-white"
        pButton
        pRipple
        [disabled]="id?.length === 0"
        (click)="getVulnerabilityReports()"
      >
        {{ 'common.search' | translate }}
      </button>
    </div>
    <span id="cveid-help">{{ 'pages.admin.vulnerabilityreports.cveid.searchHelp' | translate }}</span>
  </div>

  <ng-container *ngIf="!error; else errorOrLoading">
    <p-table [value]="vulnerabilityReports$ | async" [columns]="columns" [loading]="loading" [tableStyle]="{ 'min-width': '50rem' }">
      <ng-template pTemplate="header" let-columns>
        <tr>
          <th *ngFor="let column of columns" [pSortableColumn]="column">
            {{ 'pages.admin.vulnerabilityreports.cveid.' + column?.field | translate }}<p-sortIcon [field]="column?.field"></p-sortIcon>
          </th>
        </tr>
        <tr>
          <th *ngFor="let column of columns" class="p-0">
            <container-element [ngSwitch]="column?.type">
              <p-columnFilter *ngSwitchCase="'text'" type="text" [field]="column?.field" matchMode="contains" [showMenu]="false"></p-columnFilter>
              <p-columnFilter *ngSwitchCase="'env'" [field]="column?.field" matchMode="in" [showMenu]="false">
                <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                  <p-multiSelect
                    [ngModel]="value"
                    appendTo="body"
                    [options]="environments"
                    placeholder="{{ 'common.any' | translate }}"
                    (onChange)="filter($event.value)"
                    optionLabel="name"
                    optionValue="value"
                    [maxSelectedLabels]="1"
                    [selectedItemsLabel]="'{0} items'"
                    [filter]="false"
                  >
                  </p-multiSelect>
                </ng-template>
              </p-columnFilter>
              <p-columnFilter *ngSwitchCase="'sensitivity'" [field]="column?.field" matchMode="in" [showMenu]="false">
                <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                  <p-multiSelect
                    [ngModel]="value"
                    appendTo="body"
                    [options]="availableSensitivities"
                    placeholder="{{ 'common.any' | translate }}"
                    (onChange)="filter($event.value)"
                    optionLabel="name"
                    optionValue="value"
                    [maxSelectedLabels]="1"
                    [selectedItemsLabel]="'{0} items'"
                    [filter]="false"
                  >
                  </p-multiSelect>
                </ng-template>
              </p-columnFilter>
              <p-columnFilter *ngSwitchCase="'criticality'" [field]="column?.field" matchMode="in" [showMenu]="false">
                <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                  <p-multiSelect
                    [ngModel]="value"
                    appendTo="body"
                    [options]="availableCriticalities"
                    placeholder="{{ 'common.any' | translate }}"
                    (onChange)="filter($event.value)"
                    optionLabel="name"
                    optionValue="value"
                    [maxSelectedLabels]="1"
                    [selectedItemsLabel]="'{0} items'"
                    [filter]="false"
                  >
                  </p-multiSelect>
                </ng-template>
              </p-columnFilter>
            </container-element>
          </th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-report let-columns="columns">
        <tr>
          <ng-container *ngFor="let column of columns">
            <ng-container [ngSwitch]="column?.field">
              <td *ngSwitchCase="'clusterId'">
                <a
                  [routerLink]="['./../../cluster/' + report?.clusterId]"
                  [queryParams]="{ tab: 'vulnerabilityReports' }"
                  class="ml-2 cursor-pointer hover:text-blue-800 hover:underline dark:hover:text-blue-400"
                  >{{ report?.clusterId }}</a
                >
              </td>

              <td *ngSwitchCase="'project.name'">
                <a
                  [routerLink]="['./../projects/' + report?.project?.id]"
                  class="ml-2 cursor-pointer hover:text-blue-800 hover:underline dark:hover:text-blue-400"
                  >{{ report?.project?.name }}</a
                >
              </td>
              <td *ngSwitchCase="'environment'">
                <app-cluster-environment [environmentTag]="report?.environment"></app-cluster-environment>
              </td>
              <td *ngSwitchCase="'criticality'">
                {{ 'common.availableCriticalities.' + report[column?.field] | translate }}
              </td>
              <td *ngSwitchCase="'sensitivity'">
                {{ 'common.availableSensitivities.' + report[column?.field] | translate }}
              </td>
              <td *ngSwitchDefault>
                {{ report[column?.field] }}
              </td>
            </ng-container>
          </ng-container>
        </tr>
      </ng-template>
      <ng-template pTemplate="emptymessage">
        <tr>
          <td *ngIf="searchTimeStamp" colspan="10">
            <b>{{ searchTimeStamp }}</b
            >: {{ 'pages.admin.vulnerabilityreports.cveid.notfound' | translate }}
          </td>
          <td *ngIf="!searchTimeStamp" colspan="10">{{ 'common.emptyList' | translate }}</td>
        </tr>
      </ng-template>
    </p-table>
  </ng-container>

  <ng-template #errorOrLoading>
    <ng-container *ngIf="error">
      <div class="mx-auto my-4 flex items-center rounded-md bg-red-200 px-6 py-4 text-lg">
        <span class="p-2 text-red-800">
          {{ 'common.errorLoading' | translate }} <br />
          {{ ('common.error' | translate) + ': ' + error?.message }}
        </span>
      </div>
    </ng-container>
  </ng-template>
</div>
