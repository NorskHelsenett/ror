<div class="rounded-md bg-white dark:bg-darker p-1">
  <p-tabView>
    <p-tabPanel [header]="'common.summary' | translate">
      <p-chart type="bar" [data]="getChartData(clusterVulnerabilityReport$ | async)" />
    </p-tabPanel>
    <p-tabPanel [header]="'common.report' | translate">
      <p-table
        [value]="getVulnerabilities(clusterVulnerabilityReport$ | async)"
        [columns]="selectedColumns"
        dataKey="id"
        sortMode="multiple"
        [multiSortMeta]="defaultSort"
        [(selection)]="selectedVulnerabilities"
        [loading]="loading"
        [filters]="filters"
        [tableStyle]="{ 'min-width': '50rem' }"
      >
        <ng-template pTemplate="caption">
          <div class="flex flex-col gap-2 border-b dark:border-primary pb-2">
            <label for="columns">{{ 'pages.clustervulnerabilityreport.columns' | translate }}</label>
            <p-multiSelect
              [maxSelectedLabels]="0"
              [options]="columns"
              [(ngModel)]="selectedColumns"
              selectedItemsLabel="{0} {{ 'common.columns' | translate | lowercase }} {{ 'common.selected' | translate | lowercase }}"
              [style]="{ 'min-width': '200px' }"
              placeholder="{{ 'common.choose' | translate }} {{ 'common.columns' | translate | lowercase }}"
              id="columns"
              aria-describedby="columns-help"
            >
              <ng-template let-option pTemplate="item">
                <div class="">
                  <span class="">{{ 'pages.clustervulnerabilityreport.' + option?.label | translate }}</span>
                </div>
              </ng-template>
            </p-multiSelect>
            <small id="columns-help">{{ 'pages.clustervulnerabilityreport.columnsHelp' | translate }}</small>
          </div>
          <div class="flex flex-row justify-between gap-1 p-2">
            <div class="flex flex-col gap-2">
              <label for="status">{{ 'pages.clustervulnerabilityreport.status' | translate }}</label>
              <p-dropdown
                [options]="statuses"
                [(ngModel)]="selectedStatus"
                placeholder="{{ 'common.choose' | translate }} {{ 'pages.clustervulnerabilityreport.status' | translate | lowercase }}"
                [disabled]="selectedVulnerabilities.length === 0"
                id="status"
                aria-describedby="status-help"
              >
                <ng-template let-status pTemplate="selectedItem">
                  <div class="inline-flex align-items-center gap-2">
                    <div>{{ getStatus(status) }}</div>
                  </div>
                </ng-template>
                <ng-template let-status pTemplate="item">
                  <div class="flex align-items-center gap-2">
                    <div>{{ getStatus(status) }}</div>
                  </div>
                </ng-template>
              </p-dropdown>
              <small id="status-help">{{ 'pages.clustervulnerabilityreport.statusHelp' | translate }}</small>
            </div>
            <div class="flex flex-col gap-2">
              <label for="dismissalReason">{{ 'pages.clustervulnerabilityreport.dismissalReason' | translate }}</label>
              <p-dropdown
                [options]="dismissalReasons"
                [(ngModel)]="selectedDismissalReason"
                placeholder="{{ 'common.choose' | translate }} {{ 'pages.clustervulnerabilityreport.dismissalReason' | translate | lowercase }}"
                [disabled]="selectedVulnerabilities.length === 0 || selectedStatus !== 3"
                id="dismissalReason"
                aria-describedby="dismissalReason-help"
              >
                <ng-template let-dismissalReason pTemplate="selectedItem">
                  <div class="inline-flex align-items-center gap-2">
                    <div>{{ getDismissalReason(dismissalReason) }}</div>
                  </div>
                </ng-template>
                <ng-template let-dismissalReason pTemplate="item">
                  <div class="flex align-items-center gap-2">
                    <div>{{ getDismissalReason(dismissalReason) }}</div>
                  </div>
                </ng-template>
              </p-dropdown>
              <small id="dismissalReason-help">{{ 'pages.clustervulnerabilityreport.dismissalReasonHelp' | translate }}</small>
            </div>
            <div class="flex flex-col gap-2">
              <label for="riskAssesment">{{ 'pages.clustervulnerabilityreport.riskAssesment' | translate }}</label>
              <input
                pInputText
                [(ngModel)]="riskAssesment"
                [disabled]="selectedVulnerabilities.length === 0 || selectedStatus !== 3"
                id="riskAssesment"
                aria-describedby="riskAssesment-help"
              />
              <small id="riskAssesment-help">{{ 'pages.clustervulnerabilityreport.riskAssesmentHelp' | translate }}</small>
            </div>
            <div class="flex flex-col gap-2">
              <label for="comment">{{ 'pages.clustervulnerabilityreport.comment' | translate }}</label>
              <input
                pInputText
                [(ngModel)]="comment"
                [disabled]="selectedVulnerabilities.length === 0"
                id="comment"
                aria-describedby="comment-help"
              />
              <small id="comment-help">{{ 'pages.clustervulnerabilityreport.commentHelp' | translate }}</small>
            </div>
            <div class="flex items-center">
              <button
                pButton
                pRipple
                class="text-white px-3 py-2 rounded-md bg-green-700 hover:bg-green-600 focus:bg-green-600 max-h-10"
                (click)="updateClusterVulnerabilityReport()"
                [disabled]="selectedVulnerabilities.length === 0"
              >
                {{ 'common.update' | translate }}
              </button>
            </div>
          </div>
        </ng-template>
        <ng-template pTemplate="header" let-columns>
          <tr>
            <th style="width: 4rem"><p-tableHeaderCheckbox /></th>
            <th></th>
            @for (col of columns; track $index) {
              @switch (col?.field) {
                @case ('score') {
                  <th pSortableColumn="score" style="width: 20%">
                    {{ 'pages.clustervulnerabilityreport.' + col?.label | translate }}<p-sortIcon field="score"></p-sortIcon>
                  </th>
                }
                @case ('status.status') {
                  <th pSortableColumn="status.status" style="width: 20%">
                    {{ 'pages.clustervulnerabilityreport.' + col?.label | translate }}<p-sortIcon field="status.status"></p-sortIcon>
                  </th>
                }
                @default {
                  <th>{{ 'pages.clustervulnerabilityreport.' + col?.label | translate }}</th>
                }
              }
            }
          </tr>
          <tr>
            <th></th>
            <th></th>
            @for (col of columns; track $index) {
              @switch (col?.field) {
                @case ('status.status') {
                  <th>
                    <p-columnFilter field="status.status" matchMode="in">
                      <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                        <p-multiSelect
                          appendTo="body"
                          [maxSelectedLabels]="0"
                          [ngModel]="value"
                          [options]="statuses"
                          placeholder="{{ 'common.choose' | translate }} {{ 'pages.clustervulnerabilityreport.status' | translate | lowercase }}"
                          (onChange)="filter($event.value)"
                          selectedItemsLabel="{0} {{ 'common.columns' | translate | lowercase }} {{ 'common.selected' | translate | lowercase }}"
                        >
                          <ng-template let-option pTemplate="item">
                            <div class="inline-block vertical-align-middle">
                              <span class="ml-1 mt-1">{{ getStatus(option) }}</span>
                            </div>
                          </ng-template>
                        </p-multiSelect>
                      </ng-template>
                    </p-columnFilter>
                  </th>
                }
                @default {
                  <th></th>
                }
              }
            }
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-vulnerability let-expanded="expanded" let-columns="columns">
          <tr>
            <td>
              <p-tableCheckbox [value]="vulnerability" />
            </td>
            <td>
              <button
                type="button"
                pButton
                pRipple
                [pRowToggler]="vulnerability"
                [text]="true"
                [rounded]="true"
                [plain]="true"
                [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
              ></button>
            </td>

            @for (col of columns; track $index) {
              @switch (col?.field) {
                @case ('firstObserved') {
                  <td>{{ vulnerability?.firstObserved | date: 'dd.MM.yyyy' }}</td>
                }
                @case ('lastObserved') {
                  <td>{{ vulnerability?.lastObserved | date: 'dd.MM.yyyy' }}</td>
                }
                @case ('severity') {
                  <td>
                    <p-badge [value]="vulnerability?.severity" [severity]="getBadgeColor(vulnerability?.severity)"></p-badge>
                  </td>
                }
                @case ('status.status') {
                  <td>
                    <p-badge [value]="getStatus(vulnerability?.status?.status)" [severity]="getBadgeColor(vulnerability?.status?.status)"></p-badge>
                  </td>
                }
                @default {
                  <td>{{ getField(vulnerability, col?.field) }}</td>
                }
              }
            }
          </tr>
        </ng-template>
        <ng-template pTemplate="rowexpansion" let-vulnerability>
          <tr>
            <td colspan="10">
              <div class="p-3">
                <p-table [value]="vulnerability?.owners" dataKey="vulnerabilityID">
                  <ng-template pTemplate="header">
                    <tr>
                      <th>{{ 'pages.clustervulnerabilityreport.namespace' | translate }}</th>
                      <th>{{ 'pages.clustervulnerabilityreport.repository' | translate }}</th>
                      <th>{{ 'pages.clustervulnerabilityreport.tag' | translate }}</th>
                      <th>{{ 'pages.clustervulnerabilityreport.resource' | translate }}</th>
                      <th>{{ 'pages.clustervulnerabilityreport.installedVersion' | translate }}</th>
                      <th>{{ 'pages.clustervulnerabilityreport.fixedVersion' | translate }}</th>
                    </tr>
                  </ng-template>
                  <ng-template pTemplate="body" let-owner>
                    <tr>
                      <td>{{ owner?.namespace }}</td>
                      <td>{{ owner?.repository }}</td>
                      <td>{{ owner?.tag }}</td>
                      <td>{{ owner?.resource }}</td>
                      <td>{{ owner?.installedVersion }}</td>
                      <td>{{ owner?.fixedVersion }}</td>
                    </tr>
                  </ng-template>
                  <ng-template pTemplate="emptymessage">
                    <tr>
                      <td colspan="10">{{ 'pages.clustervulnerabilityreport.emptyTable' | translate }}</td>
                    </tr>
                  </ng-template>
                </p-table>
              </div>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="10">{{ 'pages.clustervulnerabilityreport.emptyTable' | translate }}</td>
          </tr>
        </ng-template>
      </p-table>
    </p-tabPanel>
  </p-tabView>
</div>
