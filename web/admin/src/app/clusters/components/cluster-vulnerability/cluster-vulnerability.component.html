@if (clusterVulnerabilityReport$ | async) {
  @if (!error) {
    <div class="rounded-md bg-white dark:bg-darker p-1">
      <p-tabView [(activeIndex)]="activeIndex">
        <p-tabPanel [header]="'common.summary' | translate">
          <p-chart type="bar" [data]="chartData" />
        </p-tabPanel>
        <p-tabPanel [header]="'common.report' | translate">
          <p-table
            [value]="vulnerabilities"
            [columns]="selectedColumns"
            dataKey="id"
            sortMode="multiple"
            [multiSortMeta]="defaultSort"
            [(selection)]="selectedVulnerabilities"
            [loading]="loading"
            [filters]="filters"
            [tableStyle]="{ 'min-width': '50rem' }"
            styleClass="p-datatable-sm"
          >
            >
            <ng-template pTemplate="caption">
              <div class="flex flex-col gap-2 border-b dark:border-primary pb-2">
                <p-multiSelect
                  [options]="columns"
                  [(ngModel)]="selectedColumns"
                  [maxSelectedLabels]="0"
                  selectedItemsLabel="{0} {{ 'common.columns' | translate | lowercase }} {{ 'common.selected' | translate | lowercase }}"
                  [style]="{ 'min-width': '200px' }"
                  placeholder="{{ 'common.choose' | translate }} {{ 'common.columns' | translate | lowercase }}"
                >
                  <ng-template let-column pTemplate="item">
                    <div class="">
                      <span class="">{{ 'pages.clustervulnerabilityreport.' + column?.label | translate }}</span>
                    </div>
                  </ng-template>
                </p-multiSelect>
              </div>
              <div class="flex flex-row flex-wrap justify-between gap-1 p-2">
                <p-dropdown
                  [options]="statuses"
                  optionLabel="label"
                  optionValue="value"
                  [(ngModel)]="selectedStatus"
                  placeholder="{{ 'pages.clustervulnerabilityreport.statusHelp' | translate }}"
                  [disabled]="selectedVulnerabilities?.length === 0"
                >
                  <ng-template let-status pTemplate="selectedItem">
                    <div class="inline-flex align-items-center gap-2">
                      <div>{{ status?.label | translate }}</div>
                    </div>
                  </ng-template>
                  <ng-template let-status pTemplate="item">
                    <div class="flex align-items-center gap-2">
                      <div>{{ status?.label | translate }}</div>
                    </div>
                  </ng-template>
                </p-dropdown>
                <p-dropdown
                  [options]="dismissalReasons"
                  optionLabel="label"
                  optionValue="value"
                  [(ngModel)]="selectedDismissalReason"
                  placeholder="{{ 'pages.clustervulnerabilityreport.dismissalReasonHelp' | translate }}"
                  [disabled]="selectedVulnerabilities?.length === 0 || selectedStatus !== 3"
                >
                  <ng-template let-status pTemplate="selectedItem">
                    <div class="inline-flex align-items-center gap-2">
                      <div>{{ status?.label | translate }}</div>
                    </div>
                  </ng-template>
                  <ng-template let-status pTemplate="item">
                    <div class="flex align-items-center gap-2">
                      <div>{{ status?.label | translate }}</div>
                    </div>
                  </ng-template>
                </p-dropdown>
                <input
                  pInputText
                  [(ngModel)]="riskAssesment"
                  [disabled]="selectedVulnerabilities?.length === 0 || selectedStatus !== 3"
                  placeholder="{{ 'pages.clustervulnerabilityreport.riskAssesmentHelp' | translate }}"
                />
                <input
                  pInputText
                  [(ngModel)]="comment"
                  [disabled]="selectedVulnerabilities?.length === 0"
                  placeholder="{{ 'pages.clustervulnerabilityreport.commentHelp' | translate }}"
                />
                <div class="flex flex-row items-center gap-2">
                  <button
                    pButton
                    pRipple
                    class="text-white px-3 py-2 rounded-md bg-gray-600 hover:bg-gray-500 focus:bg-gray-500 max-h-10"
                    (click)="resetSelections()"
                    [disabled]="selectedVulnerabilities?.length === 0"
                  >
                    {{ 'common.cancel' | translate }}
                  </button>
                  <button
                    pButton
                    pRipple
                    class="text-white px-3 py-2 rounded-md bg-green-700 hover:bg-green-600 focus:bg-green-600 max-h-10"
                    (click)="updateClusterVulnerabilityReport()"
                    [disabled]="selectedVulnerabilities.length === 0"
                  >
                    {{ 'common.change' | translate }} {{ 'pages.clustervulnerabilityreport.status' | translate | lowercase }}
                  </button>
                </div>
              </div>
            </ng-template>
            <ng-template pTemplate="header" let-columns>
              <tr>
                <th style="width: 4rem"><p-tableHeaderCheckbox /></th>
                <th></th>
                @for (col of columns; track $index) {
                  <th [pSortableColumn]="col?.field">
                    <div class="flex">
                      {{ 'pages.clustervulnerabilityreport.' + col?.label | translate }}
                      <p-sortIcon [field]="col?.field"></p-sortIcon>
                    </div>
                  </th>
                }
              </tr>
              <tr>
                <th></th>
                <th></th>
                @for (col of columns; track $index) {
                  @switch (col?.field) {
                    @case ('id') {
                      <th style="min-width: 175px">
                        <p-columnFilter
                          type="text"
                          field="id"
                          matchMode="contains"
                          placeholder="{{ 'pages.clustervulnerabilityreport.idHelp' | translate }}"
                          [showMenu]="false"
                        >
                        </p-columnFilter>
                      </th>
                    }
                    @case ('severity') {
                      <th style="max-width: 285px">
                        <p-columnFilter field="severity" matchMode="in" [showMenu]="false">
                          <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                            <p-multiSelect
                              appendTo="body"
                              [ngModel]="value"
                              [options]="severities"
                              optionValue="value"
                              placeholder="{{ 'common.choose' | translate }} {{
                                'pages.clustervulnerabilityreport.severity' | translate | lowercase
                              }}"
                              [maxSelectedLabels]="0"
                              selectedItemsLabel="{0} {{ 'common.selected' | translate | lowercase }}"
                              (onChange)="filter($event.value)"
                              [filter]="false"
                            >
                              <ng-template let-severity pTemplate="item">
                                <div class="inline-block vertical-align-middle">
                                  <span class="ml-1 mt-1">{{ severity?.label | translate }}</span>
                                </div>
                              </ng-template>
                            </p-multiSelect>
                          </ng-template>
                        </p-columnFilter>
                      </th>
                    }
                    @case ('status.status') {
                      <th>
                        <p-columnFilter field="status.status" matchMode="in" [showMenu]="false">
                          <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                            <p-multiSelect
                              appendTo="body"
                              [ngModel]="value"
                              [options]="statuses"
                              optionValue="value"
                              placeholder="{{ 'common.choose' | translate }} {{ 'pages.clustervulnerabilityreport.status' | translate | lowercase }}"
                              [maxSelectedLabels]="0"
                              selectedItemsLabel="{0} {{ 'common.selected' | translate | lowercase }}"
                              (onChange)="filter($event.value)"
                              [filter]="false"
                            >
                              <ng-template let-status pTemplate="item">
                                <div class="inline-block vertical-align-middle">
                                  <span class="ml-1 mt-1">{{ status?.label | translate }}</span>
                                </div>
                              </ng-template>
                            </p-multiSelect>
                          </ng-template>
                        </p-columnFilter>
                      </th>
                    }
                    @default {
                      <th></th>
                    }
                  }
                }
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-vulnerability let-expanded="expanded" let-columns="columns">
              <tr style="height: 46px">
                <td>
                  <p-tableCheckbox [value]="vulnerability" />
                </td>
                <td>
                  <button
                    type="button"
                    pButton
                    pRipple
                    [pRowToggler]="vulnerability"
                    [text]="true"
                    [rounded]="true"
                    [plain]="true"
                    [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
                  ></button>
                </td>

                @for (col of columns; track $index) {
                  <td>
                    @switch (col?.field) {
                      @case ('id') {
                        <a [href]="getField(vulnerability, 'primaryLink')" class="underline text-blue-600">{{
                          getField(vulnerability, col?.field)
                        }}</a>
                      }
                      @case ('firstObserved') {
                        {{ vulnerability?.firstObserved | date: 'dd.MM.yyyy' }}
                      }
                      @case ('lastObserved') {
                        {{ vulnerability?.lastObserved | date: 'dd.MM.yyyy' }}
                      }
                      @case ('severity') {
                        <p-badge
                          value="{{ 'common.' + vulnerability?.severity | lowercase | translate }}"
                          [severity]="getBadgeColor(vulnerability?.severity)"
                        ></p-badge>
                      }
                      @case ('status.status') {
                        <p-badge
                          value="{{ getVulnerabilityStatusLabel(vulnerability?.status?.status) | translate }}"
                          [severity]="getBadgeColor(vulnerability?.status?.status)"
                        ></p-badge>
                      }
                      @default {
                        {{ getField(vulnerability, col?.field) }}
                      }
                    }
                  </td>
                }
              </tr>
            </ng-template>
            <ng-template pTemplate="rowexpansion" let-vulnerability>
              <tr>
                <td colspan="10">
                  <div class="p-3">
                    <p-table [value]="vulnerability?.owners" dataKey="vulnerabilityID">
                      <ng-template pTemplate="header">
                        <tr>
                          <th>{{ 'pages.clustervulnerabilityreport.namespace' | translate }}</th>
                          <th>{{ 'pages.clustervulnerabilityreport.repository' | translate }}</th>
                          <th>{{ 'pages.clustervulnerabilityreport.tag' | translate }}</th>
                          <th>{{ 'pages.clustervulnerabilityreport.resource' | translate }}</th>
                          <th>{{ 'pages.clustervulnerabilityreport.installedVersion' | translate }}</th>
                          <th>{{ 'pages.clustervulnerabilityreport.fixedVersion' | translate }}</th>
                        </tr>
                      </ng-template>
                      <ng-template pTemplate="body" let-owner>
                        <tr>
                          <td>{{ owner?.namespace }}</td>
                          <td>{{ owner?.repository }}</td>
                          <td>{{ owner?.tag }}</td>
                          <td>{{ owner?.resource }}</td>
                          <td>{{ owner?.installedVersion }}</td>
                          <td>{{ owner?.fixedVersion }}</td>
                        </tr>
                      </ng-template>
                      <ng-template pTemplate="emptymessage">
                        <tr>
                          <td colspan="10">{{ 'pages.clustervulnerabilityreport.emptyTable' | translate }}</td>
                        </tr>
                      </ng-template>
                    </p-table>
                  </div>
                </td>
              </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
              <tr>
                <td colspan="10">{{ 'pages.clustervulnerabilityreport.emptyTable' | translate }}</td>
              </tr>
            </ng-template>
          </p-table>
        </p-tabPanel>
      </p-tabView>
    </div>
  } @else {
    <app-error [error]="error" (callback)="ngOnInit()"></app-error>
  }
}
