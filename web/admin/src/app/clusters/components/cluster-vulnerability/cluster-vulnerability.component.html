<div class="rounded-md bg-white dark:bg-darker p-1">
  <p-tabView>
    <p-tabPanel [header]="'common.summary' | translate">
      <p-chart type="bar" [data]="getChartData(clusterVulnerabilityReport$ | async)" />
    </p-tabPanel>
    <p-tabPanel [header]="'common.report' | translate">
      <div class="flex flex-row justify-between gap-1 p-2">
        <p-dropdown
          [options]="statuses"
          [(ngModel)]="selectedStatus"
          placeholder="{{ 'common.choose' | translate }} {{ 'pages.clustervulnerabilityreport.status' | translate | lowercase }}"
          [disabled]="selectedVulnerabilities.length == 0"
        >
          <ng-template let-status pTemplate="selectedItems">
            <div class="inline-flex align-items-center gap-2">
              <div>{{ getStatus(status) }}</div>
            </div>
          </ng-template>
          <ng-template let-status pTemplate="item">
            <div class="flex align-items-center gap-2">
              <div>{{ getStatus(status) }}</div>
            </div>
          </ng-template>
        </p-dropdown>
        @if (selectedStatus === 3) {
          <p-dropdown
            [options]="dismissalReasons"
            [(ngModel)]="selectedDismissalReason"
            placeholder="{{ 'common.choose' | translate }} {{ 'pages.clustervulnerabilityreport.dismissalReason' | translate | lowercase }}"
            [disabled]="selectedVulnerabilities.length == 0"
          >
            <ng-template let-dismissalReason pTemplate="selectedItems">
              <div class="inline-flex align-items-center gap-2">
                <div>{{ getDismissalReason(dismissalReason) }}</div>
              </div>
            </ng-template>
            <ng-template let-dismissalReason pTemplate="item">
              <div class="flex align-items-center gap-2">
                <div>{{ getDismissalReason(dismissalReason) }}</div>
              </div>
            </ng-template>
          </p-dropdown>
          <input pInputText [(ngModel)]="comment" [disabled]="selectedVulnerabilities.length == 0" />
        }
        <input pInputText [(ngModel)]="riskAssesment" [disabled]="selectedVulnerabilities.length == 0" />
        <button
          pButton
          pRipple
          class="text-white px-3 py-2 rounded-md bg-green-700 hover:bg-green-600 focus:bg-green-600"
          (click)="updateClusterVulnerabilityReport()"
          [disabled]="selectedVulnerabilities.length == 0"
        >
          {{ 'common.update' | translate }}
        </button>
      </div>

      <p-table
        [value]="getVulnerabilities(clusterVulnerabilityReport$ | async)"
        [columns]="selectedColumns"
        dataKey="id"
        sortMode="multiple"
        [multiSortMeta]="defaultSort"
        [(selection)]="selectedVulnerabilities"
        [loading]="loading"
        [filters]="filters"
        [tableStyle]="{ 'min-width': '50rem' }"
      >
        <ng-template pTemplate="caption">
          <p-multiSelect
            [maxSelectedLabels]="0"
            [options]="columns"
            [(ngModel)]="selectedColumns"
            selectedItemsLabel="{0} {{ 'common.columns' | translate | lowercase }} {{ 'common.selected' | translate | lowercase }}"
            [style]="{ 'min-width': '200px' }"
            placeholder="{{ 'common.choose' | translate }} {{ 'common.columns' | translate | lowercase }}"
          >
            <ng-template let-option pTemplate="item">
              <div class="">
                <span class="">{{ 'pages.clustervulnerabilityreport.' + option?.label | translate }}</span>
              </div>
            </ng-template>
          </p-multiSelect>
        </ng-template>
        <ng-template pTemplate="header" let-columns>
          <tr>
            <th style="width: 4rem"><p-tableHeaderCheckbox /></th>
            <th></th>
            @for (col of columns; track $index) {
              @switch (col?.field) {
                @case ('info.score') {
                  <th pSortableColumn="info.score" style="width: 20%">
                    {{ 'pages.clustervulnerabilityreport.' + col?.label | translate }}<p-sortIcon field="info.score"></p-sortIcon>
                  </th>
                }
                @case ('info.status.status') {
                  <th pSortableColumn="info.status.status" style="width: 20%">
                    {{ 'pages.clustervulnerabilityreport.' + col?.label | translate }}<p-sortIcon field="info.status.status"></p-sortIcon>
                  </th>
                }
                @default {
                  <th>{{ 'pages.clustervulnerabilityreport.' + col?.label | translate }}</th>
                }
              }
            }
          </tr>
          <tr>
            <th></th>
            <th></th>
            @for (col of columns; track $index) {
              @switch (col?.field) {
                @case ('info.status.status') {
                  <th>
                    <p-columnFilter field="info.status.status" matchMode="in">
                      <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                        <p-multiSelect
                          appendTo="body"
                          [maxSelectedLabels]="0"
                          [ngModel]="value"
                          [options]="statuses"
                          placeholder="Any"
                          (onChange)="filter($event.value)"
                          selectedItemsLabel="{0} {{ 'common.columns' | translate | lowercase }} {{ 'common.selected' | translate | lowercase }}"
                        >
                          <ng-template let-option pTemplate="item">
                            <div class="inline-block vertical-align-middle">
                              <span class="ml-1 mt-1">{{ getStatus(option) }}</span>
                            </div>
                          </ng-template>
                        </p-multiSelect>
                      </ng-template>
                    </p-columnFilter>
                  </th>
                }
                @default {
                  <th></th>
                }
              }
            }
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-vulnerability let-expanded="expanded" let-columns="columns">
          <tr>
            <td>
              <p-tableCheckbox [value]="vulnerability" />
            </td>
            <td>
              <button
                type="button"
                pButton
                pRipple
                [pRowToggler]="vulnerability"
                [text]="true"
                [rounded]="true"
                [plain]="true"
                [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
              ></button>
            </td>

            @for (col of columns; track $index) {
              @switch (col?.field) {
                @case ('info.firstObserved') {
                  <td>{{ vulnerability?.info?.firstObserved | date: 'dd.MM.yyyy' }}</td>
                }
                @case ('info.lastObserved') {
                  <td>{{ vulnerability?.info?.lastObserved | date: 'dd.MM.yyyy' }}</td>
                }
                @case ('info.severity') {
                  <td>
                    <p-badge [value]="vulnerability?.info?.severity" [severity]="getBadgeColor(vulnerability?.info?.severity)"></p-badge>
                  </td>
                }
                @case ('info.status.status') {
                  <td>
                    <p-badge
                      [value]="getStatus(vulnerability?.info?.status?.status)"
                      [severity]="getBadgeColor(vulnerability?.info?.status?.status)"
                    ></p-badge>
                  </td>
                }
                @default {
                  <td>{{ getField(vulnerability, col?.field) }}</td>
                }
              }
            }
          </tr>
        </ng-template>
        <ng-template pTemplate="rowexpansion" let-vulnerability>
          <tr>
            <td colspan="10">
              <div class="p-3">
                <p-table [value]="vulnerability?.info?.owners" dataKey="vulnerabilityID">
                  <ng-template pTemplate="header">
                    <tr>
                      <th>{{ 'pages.clustervulnerabilityreport.namespace' | translate }}</th>
                      <th>{{ 'pages.clustervulnerabilityreport.repository' | translate }}</th>
                      <th>{{ 'pages.clustervulnerabilityreport.tag' | translate }}</th>
                      <th>{{ 'pages.clustervulnerabilityreport.resource' | translate }}</th>
                      <th>{{ 'pages.clustervulnerabilityreport.installedVersion' | translate }}</th>
                      <th>{{ 'pages.clustervulnerabilityreport.fixedVersion' | translate }}</th>
                    </tr>
                  </ng-template>
                  <ng-template pTemplate="body" let-owner>
                    <tr>
                      <td>{{ owner?.namespace }}</td>
                      <td>{{ owner?.repository }}</td>
                      <td>{{ owner?.tag }}</td>
                      <td>{{ owner?.resource }}</td>
                      <td>{{ owner?.installedVersion }}</td>
                      <td>{{ owner?.fixedVersion }}</td>
                    </tr>
                  </ng-template>
                  <ng-template pTemplate="emptymessage">
                    <tr>
                      <td colspan="10">{{ 'pages.clustervulnerabilityreport.emptyTable' | translate }}</td>
                    </tr>
                  </ng-template>
                </p-table>
              </div>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="10">{{ 'pages.clustervulnerabilityreport.emptyTable' | translate }}</td>
          </tr>
        </ng-template>
      </p-table>
    </p-tabPanel>
  </p-tabView>
</div>
